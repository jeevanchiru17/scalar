<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalar | Financial Bodyguard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #09090b;
            --bg-2: #111113;
            --bg-3: #18181b;
            --bg-4: #1f1f23;
            --border: rgba(255, 255, 255, 0.06);
            --border-2: rgba(255, 255, 255, 0.12);
            --text: #fafafa;
            --text-2: #a1a1aa;
            --text-3: #71717a;
            --accent: #6366f1;
            --accent-bg: rgba(99, 102, 241, 0.1);
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.1);
            --warning: #eab308;
            --warning-bg: rgba(234, 179, 8, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --radius: 10px
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased
        }

        .app {
            display: grid;
            grid-template-columns: 1fr 340px;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            gap: 8px;
            padding: 8px
        }

        /* Header */
        .header {
            grid-column: 1/-1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 14px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--radius)
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .brand-mark {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px
        }

        .brand-name {
            font-size: 14px;
            font-weight: 600
        }

        .brand-sub {
            font-size: 9px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .metrics {
            display: flex;
            gap: 20px
        }

        .metric-val {
            font-size: 16px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace
        }

        .metric-lbl {
            font-size: 8px;
            color: var(--text-3);
            text-transform: uppercase
        }

        .status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--success-bg);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            font-size: 10px;
            color: var(--success)
        }

        .status-dot {
            width: 5px;
            height: 5px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.5
            }
        }

        /* Main panel with Three.js */
        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative
        }

        .card {
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px;
            overflow: hidden
        }

        .card-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px
        }

        /* Three.js DAG container */
        .dag-3d {
            position: relative;
            height: 320px;
            background: linear-gradient(180deg, var(--bg-2), var(--bg));
            border-radius: var(--radius);
            overflow: hidden
        }

        #dag-canvas {
            width: 100%;
            height: 100%;
            display: block
        }

        .dag-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none
        }

        .dag-label {
            position: absolute;
            font-size: 9px;
            color: var(--text);
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 6px;
            border-radius: 3px;
            transform: translate(-50%, -50%);
            white-space: nowrap
        }

        .dag-label.active {
            background: var(--accent);
            color: white
        }

        .dag-label.complete {
            background: var(--success);
            color: white
        }

        .dag-label.alert {
            background: var(--danger);
            color: white
        }

        /* Agent status bar */
        .agent-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .agent-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 10px;
            transition: all 0.2s
        }

        .agent-chip.running {
            border-color: var(--accent);
            background: var(--accent-bg);
            animation: chipPulse 1s infinite
        }

        .agent-chip.done {
            border-color: var(--success);
            background: var(--success-bg)
        }

        .agent-chip.alert {
            border-color: var(--danger);
            background: var(--danger-bg)
        }

        @keyframes chipPulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.7
            }
        }

        .agent-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-3)
        }

        .agent-chip.running .agent-dot {
            background: var(--accent)
        }

        .agent-chip.done .agent-dot {
            background: var(--success)
        }

        .agent-chip.alert .agent-dot {
            background: var(--danger)
        }

        /* Risk panel */
        .risk-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px
        }

        .risk-score-big {
            font-size: 36px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace
        }

        .risk-score-big.safe {
            color: var(--success)
        }

        .risk-score-big.critical {
            color: var(--danger)
        }

        .risk-score-big.high {
            color: var(--danger)
        }

        .risk-score-big.medium {
            color: var(--warning)
        }

        .risk-info {
            flex: 1
        }

        .risk-bar {
            height: 4px;
            background: var(--bg-4);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px
        }

        .risk-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.4s
        }

        .threat-label {
            font-size: 11px;
            font-weight: 500
        }

        /* Trajectory */
        .trajectory {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: var(--bg-3);
            border-radius: 6px;
            border-left: 3px solid var(--danger)
        }

        .trajectory.show {
            display: block
        }

        .traj-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--danger)
        }

        .traj-steps {
            font-size: 9px;
            color: var(--text-2);
            line-height: 1.6
        }

        /* Activity */
        .activity {
            display: flex;
            flex-direction: column;
            gap: 3px;
            max-height: 120px;
            overflow-y: auto
        }

        .act-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px;
            background: var(--bg-3);
            border-radius: 4px;
            font-size: 9px
        }

        .act-icon {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0
        }

        .act-icon.success {
            background: var(--success-bg)
        }

        .act-icon.warning {
            background: var(--warning-bg)
        }

        .act-icon.danger {
            background: var(--danger-bg)
        }

        .act-icon.info {
            background: var(--accent-bg)
        }

        /* Chat */
        .chat {
            display: flex;
            flex-direction: column;
            background: var(--bg-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden
        }

        .chat-head {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 500
        }

        .chat-msgs {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .msg {
            max-width: 92%;
            animation: fadeIn 0.2s
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .msg.user {
            align-self: flex-end
        }

        .msg.bot {
            align-self: flex-start
        }

        .msg-content {
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.4
        }

        .msg.user .msg-content {
            background: var(--accent);
            border-bottom-right-radius: 2px
        }

        .msg.bot .msg-content {
            background: var(--bg-4);
            border-bottom-left-radius: 2px
        }

        .msg-meta {
            font-size: 8px;
            color: var(--text-3);
            margin-top: 2px;
            display: flex;
            gap: 4px
        }

        .tag {
            display: inline-flex;
            padding: 1px 4px;
            background: var(--accent-bg);
            border-radius: 2px;
            font-size: 7px;
            font-weight: 500;
            color: var(--accent)
        }

        .chat-input {
            padding: 8px;
            border-top: 1px solid var(--border)
        }

        .quick {
            display: flex;
            gap: 3px;
            margin-bottom: 6px;
            flex-wrap: wrap
        }

        .qbtn {
            padding: 4px 6px;
            background: var(--bg-4);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-2);
            font-size: 9px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit
        }

        .qbtn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white
        }

        .input-row {
            display: flex;
            gap: 4px
        }

        .input {
            flex: 1;
            background: var(--bg-3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text);
            font-family: inherit;
            font-size: 11px;
            resize: none;
            min-height: 36px;
            max-height: 60px
        }

        .input:focus {
            outline: none;
            border-color: var(--accent)
        }

        .input::placeholder {
            color: var(--text-3)
        }

        .send {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--accent);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.15s
        }

        .send:hover {
            filter: brightness(1.1)
        }

        .send:disabled {
            opacity: 0.5
        }

        .typing {
            display: flex;
            gap: 3px;
            padding: 4px
        }

        .dot {
            width: 4px;
            height: 4px;
            background: var(--text-3);
            border-radius: 50%;
            animation: bounce 1.2s infinite
        }

        .dot:nth-child(2) {
            animation-delay: 0.15s
        }

        .dot:nth-child(3) {
            animation-delay: 0.3s
        }

        @keyframes bounce {

            0%,
            60%,
            100% {
                transform: translateY(0)
            }

            30% {
                transform: translateY(-3px)
            }
        }

        .hindi-panel {
            background: var(--warning-bg);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: 6px;
            padding: 8px;
            margin: 8px;
            display: none
        }

        .hindi-text {
            font-size: 11px;
            color: var(--warning);
            line-height: 1.4
        }

        ::-webkit-scrollbar {
            width: 3px
        }

        ::-webkit-scrollbar-track {
            background: transparent
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-4);
            border-radius: 2px
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="header">
            <div class="brand">
                <div class="brand-mark">S</div>
                <div>
                    <div class="brand-name">Scalar</div>
                    <div class="brand-sub">Financial Bodyguard</div>
                </div>
            </div>
            <div class="metrics">
                <div>
                    <div class="metric-val" id="analyses">0</div>
                    <div class="metric-lbl">Analyses</div>
                </div>
                <div>
                    <div class="metric-val" id="blocked">0</div>
                    <div class="metric-lbl">Blocked</div>
                </div>
            </div>
            <div class="status">
                <div class="status-dot"></div>Protected
            </div>
        </header>

        <!-- Main: 3D DAG & Status -->
        <main class="main-panel">
            <!-- Agent Bar -->
            <div class="card">
                <div class="card-title">ü§ñ Multi-Agent Network</div>
                <div class="agent-bar" id="agent-bar">
                    <div class="agent-chip" id="chip-orchestrator">
                        <div class="agent-dot"></div>Orchestrator
                    </div>
                    <div class="agent-chip" id="chip-upi">
                        <div class="agent-dot"></div>UPI Agent
                    </div>
                    <div class="agent-chip" id="chip-phishing">
                        <div class="agent-dot"></div>Phishing
                    </div>
                    <div class="agent-chip" id="chip-impersonation">
                        <div class="agent-dot"></div>Police Impersonation
                    </div>
                    <div class="agent-chip" id="chip-investment">
                        <div class="agent-dot"></div>Investment
                    </div>
                    <div class="agent-chip" id="chip-document">
                        <div class="agent-dot"></div>Document
                    </div>
                </div>
            </div>

            <!-- 3D DAG -->
            <div class="dag-3d">
                <canvas id="dag-canvas"></canvas>
                <div class="dag-labels" id="dag-labels"></div>
            </div>

            <!-- Risk & Trajectory -->
            <div class="card">
                <div class="risk-compact">
                    <div class="risk-score-big safe" id="risk-score">0.00</div>
                    <div class="risk-info">
                        <div class="threat-label" id="threat-label">‚úÖ SAFE</div>
                        <div class="risk-bar">
                            <div class="risk-fill" id="risk-fill" style="width:5%;background:var(--success)"></div>
                        </div>
                    </div>
                </div>
                <div class="trajectory" id="trajectory">
                    <div class="traj-title">üîç Matched: <span id="traj-name"></span></div>
                    <div class="traj-steps" id="traj-steps"></div>
                </div>
            </div>

            <!-- Activity -->
            <div class="card">
                <div class="card-title">üìä Execution Log</div>
                <div class="activity" id="activity">
                    <div class="act-item">
                        <div class="act-icon info">‚ö°</div>System ready - 6 agents loaded
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat -->
        <aside class="chat">
            <div class="chat-head">üí¨ Analyze Message</div>
            <div class="chat-msgs" id="msgs">
                <div class="msg bot">
                    <div class="msg-content">
                        ‡§®‡§Æ‡§∏‡•ç‡§§‡•á! I'm your Financial Bodyguard.<br><br>
                        Watch the <strong>3D DAG</strong> to see agents work in real-time!<br><br>
                        Try the quick buttons below ‚Üì
                    </div>
                    <div class="msg-meta"><span class="tag">Orchestrator</span></div>
                </div>
            </div>
            <div class="chat-input">
                <div class="quick">
                    <button class="qbtn" onclick="testScenario('upi')">üé∞ Lottery</button>
                    <button class="qbtn" onclick="testScenario('kyc')">üÜî KYC APK</button>
                    <button class="qbtn" onclick="testScenario('police')">üëÆ Digital Arrest</button>
                    <button class="qbtn" onclick="testScenario('invest')">üìà Crypto</button>
                </div>
                <div class="input-row">
                    <textarea class="input" id="input" placeholder="Paste suspicious message..." rows="1"
                        onkeydown="handleKey(event)"></textarea>
                    <button class="send" id="send" onclick="send()">‚û§</button>
                </div>
            </div>
            <div class="hindi-panel" id="hindi-panel">
                <div class="hindi-text" id="hindi-text"></div>
            </div>
        </aside>
    </div>

    <script>
        const API_KEY = 'AIzaSyCaA-zzt0zxkw4RGWMKZebY1JPf1oagsQQ';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

        // Trajectories with CLEAR descriptions
        const TRAJECTORIES = {
            'upi': {
                name: 'üé∞ UPI Collect Request Fraud',
                type: 'FAKE LOTTERY/PRIZE SCAM - Scammer sends collect request claiming you won prize. You DON\'T receive money, it gets DEBITED!',
                risk: 0.95,
                steps: ['1. You get message: "Won Rs 50,000!"', '2. Asked to accept UPI collect request', '3. You enter PIN thinking you\'ll receive', '4. Money DEBITED from YOUR account!', '5. Scammer disappears with your money']
            },
            'kyc': {
                name: 'üì± Fake KYC/Bank App Malware',
                type: 'PHISHING ATTACK - Fake SMS claims KYC expired. Downloads malware that steals your banking passwords and OTPs.',
                risk: 0.98,
                steps: ['1. SMS: "KYC expired, account will block"', '2. Link downloads fake banking APK', '3. APK secretly mirrors your screen', '4. You login to real bank app', '5. Scammer sees OTP, empties account!']
            },
            'police': {
                name: 'üëÆ Fake CBI/Police "Digital Arrest"',
                type: 'IMPERSONATION FRAUD - Criminals pretend to be CBI/Police on video call. Threaten "digital arrest" and demand money. REAL POLICE NEVER DO THIS!',
                risk: 0.99,
                steps: ['1. Call claiming to be from CBI/ED', '2. "Your Aadhaar linked to crime"', '3. Video call with fake uniform/office', '4. Kept on call for hours ("arrest")', '5. Forced to transfer to "safe account"']
            },
            'invest': {
                name: 'üìà Fake Crypto/Trading Platform',
                type: 'PONZI SCHEME - Fake investment platform promising impossible returns (15%/month). Initial "profits" are fake. Platform vanishes with your money.',
                risk: 0.94,
                steps: ['1. Added to WhatsApp "trading" group', '2. Shown fake profit screenshots', '3. Small investment shows "gains"', '4. Invest more, asked for "tax"', '5. Platform disappears, money gone!']
            }
        };

        let stats = { analyses: 0, blocked: 0 };
        let processing = false;

        // ============= THREE.JS DAG =============
        let scene, camera, renderer, nodes = {}, edges = [], labels = {};
        let animationFrame;

        const NODE_POSITIONS = {
            input: { x: 0, y: 1.5, z: 0 },
            orchestrator: { x: 0, y: 0.5, z: 0 },
            upi: { x: -2, y: -0.8, z: 0.5 },
            phishing: { x: -0.7, y: -0.8, z: 0.8 },
            impersonation: { x: 0.7, y: -0.8, z: 0.8 },
            investment: { x: 2, y: -0.8, z: 0.5 },
            document: { x: 0, y: -0.8, z: -0.8 },
            output: { x: 0, y: -2, z: 0 }
        };

        const NODE_LABELS = {
            input: 'INPUT',
            orchestrator: 'ORCHESTRATOR',
            upi: 'UPI',
            phishing: 'PHISHING',
            impersonation: 'POLICE',
            investment: 'INVEST',
            document: 'DOCUMENT',
            output: 'RESULT'
        };

        function initThreeJS() {
            const container = document.getElementById('dag-canvas');
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 100);
            camera.position.set(0, 1, 6);
            camera.lookAt(0, -0.3, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: container, antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);

            const point = new THREE.PointLight(0x6366f1, 1, 20);
            point.position.set(0, 3, 3);
            scene.add(point);

            // Create nodes
            Object.keys(NODE_POSITIONS).forEach(id => {
                const pos = NODE_POSITIONS[id];
                const isMain = id === 'orchestrator';
                const size = isMain ? 0.35 : 0.25;

                const geometry = new THREE.SphereGeometry(size, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x3f3f46,
                    emissive: 0x000000,
                    shininess: 100
                });

                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(pos.x, pos.y, pos.z);
                mesh.userData = { id, originalColor: 0x3f3f46 };
                scene.add(mesh);
                nodes[id] = mesh;
            });

            // Create edges
            const edgeList = [
                ['input', 'orchestrator'],
                ['orchestrator', 'upi'],
                ['orchestrator', 'phishing'],
                ['orchestrator', 'impersonation'],
                ['orchestrator', 'investment'],
                ['orchestrator', 'document'],
                ['upi', 'output'],
                ['phishing', 'output'],
                ['impersonation', 'output'],
                ['investment', 'output'],
                ['document', 'output']
            ];

            edgeList.forEach(([from, to]) => {
                const p1 = NODE_POSITIONS[from];
                const p2 = NODE_POSITIONS[to];

                const points = [
                    new THREE.Vector3(p1.x, p1.y, p1.z),
                    new THREE.Vector3(p2.x, p2.y, p2.z)
                ];

                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: 0x27272a, linewidth: 1 });
                const line = new THREE.Line(geometry, material);
                line.userData = { from, to };
                scene.add(line);
                edges.push(line);
            });

            // Create labels
            updateLabels();

            animate();
        }

        function updateLabels() {
            const labelsContainer = document.getElementById('dag-labels');
            labelsContainer.innerHTML = '';

            Object.keys(nodes).forEach(id => {
                const node = nodes[id];
                const label = document.createElement('div');
                label.className = 'dag-label';
                label.id = `label-${id}`;
                label.textContent = NODE_LABELS[id];
                labelsContainer.appendChild(label);
                labels[id] = label;
            });
        }

        function projectToScreen(position) {
            const vector = position.clone();
            vector.project(camera);

            const canvas = document.getElementById('dag-canvas');
            const x = (vector.x * 0.5 + 0.5) * canvas.offsetWidth;
            const y = (-vector.y * 0.5 + 0.5) * canvas.offsetHeight;

            return { x, y };
        }

        function animate() {
            animationFrame = requestAnimationFrame(animate);

            // Gentle rotation
            scene.rotation.y = Math.sin(Date.now() * 0.0003) * 0.15;

            // Update label positions
            Object.keys(nodes).forEach(id => {
                const node = nodes[id];
                const label = labels[id];
                if (label) {
                    const pos = projectToScreen(node.position);
                    label.style.left = pos.x + 'px';
                    label.style.top = (pos.y - 20) + 'px';
                }
            });

            renderer.render(scene, camera);
        }

        function setNodeState(nodeId, state) {
            const node = nodes[nodeId];
            const label = labels[nodeId];
            const chip = document.getElementById(`chip-${nodeId}`);

            if (node) {
                let color, emissive;
                switch (state) {
                    case 'running':
                        color = 0x6366f1;
                        emissive = 0x4338ca;
                        break;
                    case 'complete':
                        color = 0x22c55e;
                        emissive = 0x15803d;
                        break;
                    case 'alert':
                        color = 0xef4444;
                        emissive = 0xdc2626;
                        break;
                    default:
                        color = 0x3f3f46;
                        emissive = 0x000000;
                }
                node.material.color.setHex(color);
                node.material.emissive.setHex(emissive);
            }

            if (label) {
                label.className = 'dag-label';
                if (state !== 'idle') label.classList.add(state);
            }

            if (chip) {
                chip.className = 'agent-chip';
                if (state !== 'idle') chip.classList.add(state);
            }
        }

        function setEdgeState(fromId, toId, active) {
            edges.forEach(edge => {
                if (edge.userData.from === fromId && edge.userData.to === toId) {
                    edge.material.color.setHex(active ? 0x6366f1 : 0x27272a);
                }
            });
        }

        function resetDAG() {
            Object.keys(nodes).forEach(id => setNodeState(id, 'idle'));
            edges.forEach(e => e.material.color.setHex(0x27272a));
        }

        // ============= ANALYSIS =============
        function routeAgents(msg) {
            const m = msg.toLowerCase();
            const agents = [];
            if (/collect|won|lottery|prize|upi|pay|qr|receive/.test(m)) agents.push('upi');
            if (/kyc|apk|download|block|link|verify|24\s*hours/.test(m)) agents.push('phishing');
            if (/police|cbi|ed|arrest|warrant|customs|aadhaar/.test(m)) agents.push('impersonation');
            if (/invest|return|profit|crypto|double|forex|trading/.test(m)) agents.push('investment');
            if (/loan|insurance|emi|policy|premium/.test(m)) agents.push('document');
            if (agents.length === 0) agents.push('upi', 'phishing', 'impersonation');
            return agents;
        }

        function detectTrajectory(msg) {
            const m = msg.toLowerCase();
            if (/cbi|police|ed|arrest|warrant|digital/.test(m)) return 'police';
            if (/kyc|apk|download|block/.test(m)) return 'kyc';
            if (/collect|won|lottery|prize/.test(m)) return 'upi';
            if (/invest|crypto|return|profit|guaranteed/.test(m)) return 'invest';
            return null;
        }

        async function runDAGAnimation(agents) {
            resetDAG();

            // Step 1: Input
            setNodeState('input', 'running');
            addActivity('Input received', 'info');
            await delay(300);
            setNodeState('input', 'complete');
            setEdgeState('input', 'orchestrator', true);

            // Step 2: Orchestrator
            setNodeState('orchestrator', 'running');
            addActivity('Orchestrator routing to agents...', 'info');
            await delay(400);

            // Step 3: Route to agents
            for (const agent of agents) {
                setEdgeState('orchestrator', agent, true);
            }
            setNodeState('orchestrator', 'complete');
            await delay(200);

            // Step 4: Parallel agent execution
            addActivity(`Running ${agents.length} agents in parallel`, 'info');
            agents.forEach(a => setNodeState(a, 'running'));
            await delay(600);

            // Step 5: Agents complete
            agents.forEach(a => {
                setNodeState(a, 'complete');
                setEdgeState(a, 'output', true);
            });
            addActivity('All agents completed', 'success');
            await delay(300);

            // Step 6: Output
            setNodeState('output', 'running');
            await delay(200);

            return agents;
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

        function updateRisk(score, level) {
            const el = document.getElementById('risk-score');
            const fill = document.getElementById('risk-fill');
            const label = document.getElementById('threat-label');

            el.textContent = score.toFixed(2);
            el.className = 'risk-score-big ' + level;

            fill.style.width = `${Math.max(score * 100, 5)}%`;
            fill.style.background = level === 'safe' || level === 'low' ? 'var(--success)' :
                level === 'medium' ? 'var(--warning)' : 'var(--danger)';

            const labels = {
                safe: '‚úÖ SAFE',
                low: '‚úÖ LOW RISK',
                medium: '‚ö†Ô∏è MEDIUM RISK',
                high: 'üö® HIGH RISK',
                critical: 'üö® CRITICAL THREAT'
            };
            label.textContent = labels[level];
        }

        function showTrajectory(key) {
            const traj = TRAJECTORIES[key];
            if (!traj) return;

            document.getElementById('traj-name').textContent = traj.name;
            document.getElementById('traj-steps').innerHTML =
                `<strong style="color:var(--danger);display:block;margin-bottom:6px;">${traj.type}</strong>` +
                traj.steps.join('<br>');
            document.getElementById('trajectory').classList.add('show');
        }

        function addActivity(text, type = 'info') {
            const list = document.getElementById('activity');
            const icons = { success: '‚úì', warning: '‚ö†', danger: '‚úï', info: '‚Ä¢' };
            const item = document.createElement('div');
            item.className = 'act-item';
            item.innerHTML = `<div class="act-icon ${type}">${icons[type]}</div>${text}`;
            list.insertBefore(item, list.firstChild);
            while (list.children.length > 6) list.removeChild(list.lastChild);
        }

        // Chat
        function addMsg(text, isUser = false, agent = 'Orchestrator') {
            const msgs = document.getElementById('msgs');
            const div = document.createElement('div');
            div.className = `msg ${isUser ? 'user' : 'bot'}`;
            div.innerHTML = `<div class="msg-content">${format(text)}</div><div class="msg-meta">${!isUser ? `<span class="tag">${agent}</span>` : ''}</div>`;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function format(t) { return t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); }

        function addTyping() {
            const msgs = document.getElementById('msgs');
            const div = document.createElement('div');
            div.className = 'msg bot'; div.id = 'typing';
            div.innerHTML = '<div class="msg-content"><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function removeTyping() { const t = document.getElementById('typing'); if (t) t.remove(); }

        async function send() {
            const input = document.getElementById('input');
            const msg = input.value.trim();
            if (!msg || processing) return;

            processing = true;
            document.getElementById('send').disabled = true;
            document.getElementById('trajectory').classList.remove('show');
            document.getElementById('hindi-panel').style.display = 'none';

            addMsg(msg, true);
            input.value = '';

            stats.analyses++;
            document.getElementById('analyses').textContent = stats.analyses;

            // Run DAG animation
            const agents = routeAgents(msg);
            await runDAGAnimation(agents);

            // Detect trajectory
            const trajKey = detectTrajectory(msg);
            if (trajKey) showTrajectory(trajKey);

            addTyping();

            try {
                const res = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are Financial Bodyguard. Analyze for fraud: "${msg}"\n\nRespond:\n**Risk: X.XX**\n**Type:** [type]\n**Action:** [advice]\n**‡§π‡§ø‡§Ç‡§¶‡•Ä:** [hindi]` }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 400 }
                    })
                });

                removeTyping();

                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;

                addMsg(text, false, 'Multi-Agent');

                // Extract risk
                const riskMatch = text.match(/Risk:\s*(\d+\.?\d*)/i);
                const risk = riskMatch ? parseFloat(riskMatch[1]) : (trajKey ? TRAJECTORIES[trajKey].risk : 0.5);

                const level = risk >= 0.9 ? 'critical' : risk >= 0.7 ? 'high' : risk >= 0.4 ? 'medium' : risk > 0.1 ? 'low' : 'safe';
                updateRisk(risk, level);

                // Mark output
                setNodeState('output', level === 'safe' || level === 'low' ? 'complete' : 'alert');

                if (risk >= 0.7) {
                    stats.blocked++;
                    document.getElementById('blocked').textContent = stats.blocked;
                    addActivity('üö® THREAT BLOCKED', 'danger');
                    agents.forEach(a => setNodeState(a, 'alert'));
                }

                // Hindi
                const hindiMatch = text.match(/‡§π‡§ø‡§Ç‡§¶‡•Ä[:\s]*(.+?)(?=\n\n|\n\*|$)/s);
                if (hindiMatch) {
                    document.getElementById('hindi-text').innerHTML = hindiMatch[1].trim();
                    document.getElementById('hindi-panel').style.display = 'block';
                }

            } catch (e) {
                removeTyping();
                if (trajKey) {
                    const traj = TRAJECTORIES[trajKey];
                    addMsg(`**Risk: ${traj.risk}**\n**Type:** ${traj.name}\n**Action:** This is a known scam pattern. Do NOT proceed!\n**‡§π‡§ø‡§Ç‡§¶‡•Ä:** ‡§Ø‡§π ‡§ß‡•ã‡§ñ‡§æ‡§ß‡§°‡§º‡•Ä ‡§π‡•à! ‡§Ü‡§ó‡•á ‡§® ‡§¨‡§¢‡§º‡•á‡§Ç!`, false, 'Fallback');
                    updateRisk(traj.risk, 'critical');
                    setNodeState('output', 'alert');
                    agents.forEach(a => setNodeState(a, 'alert'));
                    stats.blocked++;
                    document.getElementById('blocked').textContent = stats.blocked;
                }
            }

            processing = false;
            document.getElementById('send').disabled = false;
        }

        function testScenario(type) {
            const scenarios = {
                upi: 'Congratulations! You won Rs 50,000 lottery! Accept UPI collect request from 9876543210 to receive your prize. Valid 24 hours!',
                kyc: 'Dear SBI Customer: Your KYC expired. Account will be BLOCKED in 24 hours. Update now: bit.ly/sbi-kyc or download sbi-update.apk',
                police: 'This is Officer Sharma, CBI. Your Aadhaar is linked to money laundering. Digital arrest warrant issued. Transfer Rs 2,00,000 to avoid arrest.',
                invest: 'Join our crypto trading group! Guaranteed 15% monthly returns. No risk. Daily profits. Join with Rs 10,000 - become crorepati!'
            };
            document.getElementById('input').value = scenarios[type];
            send();
        }

        function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } }

        // Init
        window.addEventListener('load', () => {
            initThreeJS();
            document.getElementById('input').addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 60) + 'px';
            });
        });

        window.addEventListener('resize', () => {
            if (renderer) {
                const container = document.getElementById('dag-canvas');
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        });
    </script>
</body>

</html>